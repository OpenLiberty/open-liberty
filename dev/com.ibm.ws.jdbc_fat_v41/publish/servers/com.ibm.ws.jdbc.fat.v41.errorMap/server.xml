<server>
    <featureManager>
        <feature>componenttest-1.0</feature>
        <feature>servlet-3.1</feature>
        <feature>jdbc-4.1</feature>
        <feature>jndi-1.0</feature>
    </featureManager>
    
    <include location="../fatTestPorts.xml"/>

    <application location="errorMappingApp.war" >
        <classloader commonLibraryRef="CustomDriverLib"/>
    </application>
    
    <library id="CustomDriverLib">
        <fileset dir="${server.config.dir}/derby" includes="derby.jar,errorMappingDriver.jar"/>
    </library>
    
    <jdbcDriver id="CustomDriver" libraryRef="CustomDriverLib" javax.sql.DataSource="jdbc.fat.v41.errormap.driver.ErrorMapDataSourceImpl"/>
    
    <dataSource jndiName="jdbc/errorMap" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
        <mapError sqlCode="1234" to="STALE_CONNECTION"/>
    </dataSource>
    
    <dataSource jndiName="jdbc/noMappings" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
    </dataSource>
    
    <dataSource jndiName="jdbc/removeMapping" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
        <mapError sqlState="08001" to="NONE"/>
    </dataSource>
    
    <dataSource jndiName="jdbc/manyMappings" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
        <mapError sqlCode="0001" to="STALE_CONNECTION"/>
        <mapError sqlCode="2" to="STALE_CONNECTION"/>
        <mapError sqlCode="1003" to="STALE_CONNECTION"/>
        <mapError sqlState="E1004" to="STALE_CONNECTION"/>
        <mapError sqlState="5" to="STALE_CONNECTION"/>
        <mapError sqlCode="6" to="STALE_CONNECTION"/>
        <mapError sqlCode="7" to="STALE_CONNECTION"/>
        <mapError sqlCode="-008" to="STALE_CONNECTION"/>
        <mapError sqlCode="-10009" to="STALE_CONNECTION"/>
        <mapError sqlCode="1010" to="NONE"/>
        <mapError sqlState="E1111" to="STALE_CONNECTION"/>
    </dataSource>
    
    <dataSource jndiName="jdbc/invalid/noTarget" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
        <!-- invalid configuration: the 'to' attribute is not defined-->
        <mapError sqlCode="1234"/>
    </dataSource>
    
    <dataSource jndiName="jdbc/invalid/bogusTarget" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
        <!-- invalid configuration: the value "BOGUS" is not an allowed value for the 'to' attribute -->
        <mapError sqlCode="1234" to="BOGUS"/>
    </dataSource>
    
    <dataSource jndiName="jdbc/invalid/noStateOrCode" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
        <!-- invalid configuration: either sqlCode or sqlState must be defined -->
        <mapError to="STALE_CONNECTION"/>
    </dataSource>
    
    <dataSource jndiName="jdbc/invalid/stateAndCode" type="javax.sql.DataSource" jdbcDriverRef="CustomDriver">
        <properties.derby.embedded databaseName="memory:ds1" createDatabase="create"/>
        <!-- invalid configuration: sqlCode and sqlState are mutually exclusive -->
        <mapError sqlCode="1234" sqlState="E1234" to="STALE_CONNECTION"/>
    </dataSource>
    
    <javaPermission codebase="${server.config.dir}/derby/derby.jar" className="java.security.AllPermission"/>
    <javaPermission codebase="${server.config.dir}/apps/errorMappingApp.war" className="java.sql.SQLPermission" name="callAbort"/>
    <javaPermission codebase="${server.config.dir}/apps/errorMappingApp.war" className="java.lang.RuntimePermission" name="accessDeclaredMembers"/>
    <javaPermission codebase="${server.config.dir}/apps/errorMappingApp.war" className="java.lang.RuntimePermission" name="getClassLoader"/>
    <javaPermission codebase="${server.config.dir}/apps/errorMappingApp.war" className="java.lang.reflect.ReflectPermission" name="suppressAccessChecks"/>

    <!--  Permissions for application to access mbeans -->
    <javaPermission codebase="${server.config.dir}/apps/errorMappingApp.war" className="javax.management.MBeanPermission" actions="queryNames"/>
    <javaPermission codebase="${server.config.dir}/apps/errorMappingApp.war" className="javax.management.MBeanServerPermission" name="createMBeanServer"/>
    
    <variable name="onError" value="FAIL"/>
</server>