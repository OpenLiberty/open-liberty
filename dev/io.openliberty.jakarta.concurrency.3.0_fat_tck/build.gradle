/*******************************************************************************
 * Copyright (c) 2022 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     IBM Corporation - initial API and implementation
 *******************************************************************************/

configurations {
	testNG { transitive = false; }
  arquillian
  wlp
}

dependencies {
	testNG 'org.testng:testng:6.14.3',
	       'com.beust:jcommander:1.78',
	       'org.apache-extras.beanshell:bsh:2.0b6'

  arquillian 'io.openliberty.arquillian:arquillian-liberty-support-jakarta:2.0.1'

  //TODO configure WLP dependency, Examples (may not be valid):
  //wlp 'io.openliberty.beta:openliberty-jakartaee10:22.0.0.2-beta@zip'
  //wlp 'io.openliberty.beta:openliberty-runtime:22.0.0.2-beta@zip'    
  //wlp 'io.openliberty:openliberty-jakartaee9:22.0.0.1@zip'
}

task copyTestNG(type: Copy) {
  mustRunAfter jar
  from configurations.testNG
  into new File(autoFvtDir, 'publish/shared/resources/testng/6.14.3')
  rename 'testng-.*.jar', 'testng.jar'
  rename 'jcommander-.*.jar', 'jcommander.jar'
  rename 'bsh-.*.jar', 'bsh.jar'
}

addRequiredLibraries.dependsOn addDerby
addRequiredLibraries.dependsOn copyTestNG


// These tasks are used only for external users who do not want to build all of liberty to run TCK
task getWLP(type: Copy) {
  from configurations.wlp.collect{zipTree (it)}
  into project.projectDir
}

task copyArquillianFeatureWLP(type: Copy) {
  mustRunAfter getWLP
  from configurations.arquillian
  into new File(project.projectDir, 'wlp/usr/extension/')
}

task createServer(type: Exec) {
  mustRunAfter getWLP
  workingDir project.projectDir
  commandLine './wlp/bin/server', 'create', 'ConcurrentTCKServer'
}

task copyTestNGWLP(type: Copy) {
  mustRunAfter createServer
  from configurations.testNG
  into new File(project.projectDir, 'wlp/usr/shared/resources/testng/6.14.3')
  rename 'testng-.*.jar', 'testng.jar'
  rename 'jcommander-.*.jar', 'jcommander.jar'
  rename 'bsh-.*.jar', 'bsh.jar'
}

task copyDerbyWLP(type: Copy) {
  mustRunAfter createServer
  from configurations.derby
  into new File(project.projectDir, 'wlp/usr/shared/resources/derby/')
  rename 'derby-.*.jar', 'derby.jar'
}

task copyConfigWLP(type: Copy) {
  mustRunAfter createServer
  from new File(project.projectDir, 'publish/servers/ConcurrentTCKServer')
  into new File(project.projectDir, 'wlp/usr/servers/ConcurrentTCKServer/')
  exclude '**/bootstrap.properties' //Specific to Open Liberty test infrastructure
  exclude 'configDropins/*'         //Specific to Open Liberty test infrastructure
}

task copyRunnerWLP(type: Copy) {
  mustRunAfter createServer
  from new File(project.projectDir, 'publish/tckRunner/')
  into new File(project.projectDir, 'wlp/')
  exclude 'tck/pom.xml' //remove the pom we use for dev testing
  rename 'standalone.pom.xml', 'pom.xml' //replace with the standalone pom
}

task buildWLP {
  dependsOn 'getWLP'
  dependsOn 'copyArquillianFeatureWLP'
  dependsOn 'createServer'
  dependsOn 'copyTestNGWLP'
  dependsOn 'copyDerbyWLP'
  dependsOn 'copyConfigWLP'
  dependsOn 'copyRunnerWLP'
}