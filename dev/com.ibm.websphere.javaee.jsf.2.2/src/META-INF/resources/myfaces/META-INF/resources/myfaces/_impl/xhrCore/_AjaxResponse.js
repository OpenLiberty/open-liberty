/*******************************************************************************
 * Copyright (c) 2017 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     IBM Corporation - initial API and implementation
 *******************************************************************************/
_MF_SINGLTN(_PFX_XHR+"_AjaxResponse",_MF_OBJECT,{RESP_PARTIAL:"partial-response",RESP_TYPE_ERROR:"error",RESP_TYPE_REDIRECT:"redirect",RESP_TYPE_CHANGES:"changes",CMD_CHANGES:"changes",CMD_UPDATE:"update",CMD_DELETE:"delete",CMD_INSERT:"insert",CMD_EVAL:"eval",CMD_ERROR:"error",CMD_ATTRIBUTES:"attributes",CMD_EXTENSION:"extension",CMD_REDIRECT:"redirect",P_VIEWSTATE:"javax.faces.ViewState",P_CLIENTWINDOW:"javax.faces.ClientWindow",P_VIEWROOT:"javax.faces.ViewRoot",P_VIEWHEAD:"javax.faces.ViewHead",P_VIEWBODY:"javax.faces.ViewBody",processResponse:function(G,C){C._mfInternal=C._mfInternal||{};var B=C._mfInternal;B._updateElems=[];B._updateForms=[];B.appliedViewState=null;B.appliedClientWindow=null;try{var K=this.attr("impl"),E=this._Lang;if(!G||!E.exists(G,"responseXML")){throw this.makeException(new Error(),K.EMPTY_RESPONSE,K.EMPTY_RESPONSE,this._nameSpace,"processResponse","");}var F=G.responseXML;var I=E.fetchXMLErrorMessage(G.responseText||G.response,F);if(I){throw this._raiseError(new Error(),I.errorMessage+"\n"+I.sourceText+"\n"+I.visualError+"\n","processResponse");}var J=F.childNodes[0];if("undefined"==typeof J||J==null){throw this._raiseError(new Error(),"No child nodes for response","processResponse");}else{if(J.tagName!=this.RESP_PARTIAL){J=J.nextSibling;if(!J||J.tagName!=this.RESP_PARTIAL){throw this._raiseError(new Error(),"Partial response not set","processResponse");}}}var L=J.childNodes.length;for(var H=0;H<L;H++){var A=J.childNodes[H];var D=A.tagName;if(D==this.CMD_ERROR){this.processError(G,C,A);}else{if(D==this.CMD_REDIRECT){this.processRedirect(G,C,A);}else{if(D==this.CMD_CHANGES){this.processChanges(G,C,A);}}}}if(B.appliedViewState){this.fixViewStates(C);}if(B.appliedClientWindow){this.fixClientWindows(C);}K.sendEvent(G,C,K["SUCCESS"]);}finally{delete B._updateElems;delete B._updateForms;delete B.appliedViewState;delete B.appliedClientWindow;}},fixViewStates:function(C){var B=this._Lang;var D=C._mfInternal;if(null==D.appliedViewState){return ;}if(this._RT.getLocalOrGlobalConfig(C,"no_portlet_env",false)){for(var A=document.forms.length-1;A>=0;A--){this._setVSTCWForm(C,document.forms[A],D.appliedViewState,this.P_VIEWSTATE);}return ;}B.arrForEach(D._updateForms,function(E){this._setVSTCWForm(C,E,D.appliedViewState,this.P_VIEWSTATE);},0,this);B.arrForEach(D._updateElems,function(E){this._setVSTCWInnerForms(C,E,D.appliedViewState,this.P_VIEWSTATE);},0,this);},fixClientWindows:function(C,E){var B=this._Lang;var D=C._mfInternal;if(null==D.appliedClientWindow){return ;}if(this._RT.getLocalOrGlobalConfig(C,"no_portlet_env",false)){for(var A=document.forms.length-1;A>=0;A--){this._setVSTCWForm(C,document.forms[A],D.appliedClientWindow,this.P_CLIENTWINDOW);}return ;}B.arrForEach(D._updateForms,function(F){this._setVSTCWForm(C,F,D.appliedClientWindow,this.P_CLIENTWINDOW);},0,this);B.arrForEach(D._updateElems,function(F){this._setVSTCWInnerForms(C,F,D.appliedClientWindow,this.P_CLIENTWINDOW);},0,this);},_setVSTCWForm:function(C,G,D,A){G=this._Lang.byId(G);var F=C._mfInternal;if(!G){return ;}var E=this._Dom.getNamedElementFromForm(G,A);if(E){this._Dom.setAttribute(E,"value",D);}else{if(!E){var B=this._Dom.getDummyPlaceHolder();B.innerHTML=["<input type='hidden'","id='",A+jsf.separatorchar+Math.random(),"' name='",A,"' value='",D,"' />"].join("");try{G.appendChild(B.childNodes[0]);}finally{B.innerHTML="";}}}},_setVSTCWInnerForms:function(C,F,G,A){var B=this._Lang,E=this._Dom;F=E.byIdOrName(F);if(!F){return ;}var H=E.findByTagName(F,"form",false);var D=B.hitch(this,function(I){this._setVSTCWForm(C,I,G,A);});try{B.arrForEach(H,D,0,this);}finally{D=null;}},processError:function(E,B,D){var C=D.firstChild.textContent||D.firstChild.text||"",A=D.childNodes[1].firstChild.data||"";this.attr("impl").sendError(E,B,this.attr("impl").SERVER_ERROR,C,A,"myfaces._impl.xhrCore._AjaxResponse","processError");},processRedirect:function(D,B,C){var A=this._Lang;var E=C.getAttribute("url");if(!E){throw this._raiseError(new Error(),A.getMessage("ERR_RED_URL",null,"_AjaxResponse.processRedirect"),"processRedirect");}E=A.trim(E);if(E==""){return false;}window.location=E;return true;},processChanges:function(F,C,E){var D=E.childNodes;var B=this._Lang;for(var A=0;A<D.length;A++){switch(D[A].tagName){case this.CMD_UPDATE:this.processUpdate(F,C,D[A]);break;case this.CMD_EVAL:B.globalEval(D[A].firstChild.data);break;case this.CMD_INSERT:this.processInsert(F,C,D[A]);break;case this.CMD_DELETE:this.processDelete(F,C,D[A]);break;case this.CMD_ATTRIBUTES:this.processAttributes(F,C,D[A]);break;case this.CMD_EXTENSION:break;default:throw this._raiseError(new Error(),"_AjaxResponse.processChanges: Illegal Command Issued","processChanges");}}return true;},processUpdate:function(G,B,E){if((E.getAttribute("id").indexOf(this.P_VIEWSTATE)!=-1)||(E.getAttribute("id").indexOf(this.P_CLIENTWINDOW)!=-1)){var A=B._mfInternal,I=this._Lang.hitch(this._Dom,this._Dom.fuzzyFormDetection);var D=(A._mfSourceControlId)?A._mfSourceControlId:((B.source)?B.source.id:null);var C=(A&&A["_mfSourceFormId"]&&document.forms[A["_mfSourceFormId"]])?document.forms[A["_mfSourceFormId"]]:((D)?I(D):null);if(E.getAttribute("id").indexOf(this.P_VIEWSTATE)!=-1){A.appliedViewState=this._Dom.concatCDATABlocks(E);}else{if(E.getAttribute("id").indexOf(this.P_CLIENTWINDOW)!=-1){A.appliedClientWindow=E.firstChild.nodeValue;}}if(!C){return true;}A._updateForms.push(C.id);}else{var H=this._Dom.concatCDATABlocks(E),K=null,F=this._Lang.hitch(this,this._pushOperationResult);switch(E.getAttribute("id")){case this.P_VIEWROOT:H=H.substring(H.indexOf("<html"));var J=this._replaceHead(G,B,H);K=("undefined"!=typeof J&&null!=J)?this._replaceBody(G,B,H,J):this._replaceBody(G,B,H);if(K){F(B,K);}break;case this.P_VIEWHEAD:this._replaceHead(G,B,H);break;case this.P_VIEWBODY:K=this._replaceBody(G,B,H);if(K){F(B,K);}break;default:K=this.replaceHtmlItem(G,B,E.getAttribute("id"),H);if(K){F(B,K);}break;}}return true;},_pushOperationResult:function(C,A){var F=C._mfInternal;var E=this._Lang.hitch(this,function(H){var G=this._Dom.getParent(H,"form");if(null!=G){F._updateForms.push(G.id||G);}else{F._updateElems.push(H.id||H);}});var D="undefined"!=typeof A.length&&"undefined"==typeof A.nodeType;if(D&&A.length){for(var B=0;B<A.length;B++){E(A[B]);}}else{if(!D){E(A);}}},_replaceHead:function(F,C,L){var D=this._Lang,I=this._Dom,G=this._RT.browser.isWebKit,J=(!G)?D.parseXML(L):null,E=null;if(!G&&D.isXMLParseError(J)){J=D.parseXML(L.replace(/<!\-\-[\s\n]*<!\-\-/g,"<!--").replace(/\/\/-->[\s\n]*\/\/-->/g,"//-->"));}if(G||D.isXMLParseError(J)){var B=new (this._RT.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();var K=B.parse(L,"head");E=D.parseXML("<head>"+K+"</head>");if(D.isXMLParseError(E)){try{E=I.createElement("head");E.innerHTML=K;}catch(H){throw this._raiseError(new Error(),"Error head replacement failed reason:"+H.toString(),"_replaceHead");}}}else{E=J.getElementsByTagName("head")[0];}var A=I.findByTagNames(document.getElementsByTagName("head")[0],{"link":true,"style":true});I.runCss(E,true);I.deleteItems(A);I.runScripts(E,true);return J;},_replaceBody:function(E,B,Q){var I=this._RT,M=this._Dom,D=this._Lang,K=document.getElementsByTagName("body")[0],P=document.createElement("div"),F=I.browser.isWebKit;P.id="myfaces_bodyplaceholder";M._removeChildNodes(K);K.innerHTML="";K.appendChild(P);var H,O=null,A;if(!F){O=(arguments.length>3)?arguments[3]:D.parseXML(Q);}if(!F&&D.isXMLParseError(O)){O=D.parseXML(Q.replace(/<!\-\-[\s\n]*<!\-\-/g,"<!--").replace(/\/\/-->[\s\n]*\/\/-->/g,"//-->"));}if(F||D.isXMLParseError(O)){A=new (I.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();H=A.parse(Q,"body");}else{var J=O.getElementsByTagName("body")[0];var G=I.browser;if(!G.isIEMobile||G.isIEMobile>=7){for(var C=0;C<J.attributes.length;C++){var N=J.attributes[C].value;if(N){M.setAttribute(K,J.attributes[C].name,N);}}}}A=new (I.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();H=A.parse(Q,"body");var L=this.replaceHtmlItem(E,B,P,H);if(L){this._pushOperationResult(B,L);}return L;},replaceHtmlItem:function(F,C,G,A){var B=this._Lang,E=this._Dom;var D=(!B.isString(G))?G:E.byIdOrName(G);if(!D){throw this._raiseError(new Error(),B.getMessage("ERR_ITEM_ID_NOTFOUND",null,"_AjaxResponse.replaceHtmlItem",(G)?G.toString():"undefined"),"replaceHtmlItem");}return E.outerHTML(D,A,this._RT.getLocalOrGlobalConfig(C,"preserveFocus",false));},processInsert:function(H,C,G){var F=this._Dom,B=this._Lang,E=this._parseInsertData(H,C,G);if(!E){return false;}var D=F.byIdOrName(E.opId);if(!D){throw this._raiseError(new Error(),B.getMessage("ERR_PPR_INSERTBEFID_1",null,"_AjaxResponse.processInsert",E.opId),"processInsert");}var A=F[E.insertType](D,E.cDataBlock);if(A){this._pushOperationResult(C,A);}return true;},_parseInsertData:function(J,C,F){var G=this._Lang,M=this._Dom,H=M.concatCDATABlocks,N="insertBefore",D="insertAfter",B=F.getAttribute("id"),E=F.getAttribute("before"),K=F.getAttribute("after"),L={};if(B&&E&&!K){L.insertType=N;L.opId=E;L.cDataBlock=H(F);}else{if(B&&!E&&K){L.insertType=D;L.opId=K;L.cDataBlock=H(F);}else{if(!B){var I=F.childNodes[0].tagName;if(I!="before"&&I!="after"){throw this._raiseError(new Error(),G.getMessage("ERR_PPR_INSERTBEFID"),"_parseInsertData");}I=I.toLowerCase();var A=F.childNodes[0].getAttribute("id");L.insertType=(I=="before")?N:D;L.opId=A;L.cDataBlock=H(F.childNodes[0]);}else{throw this._raiseError(new Error(),[G.getMessage("ERR_PPR_IDREQ"),"\n ",G.getMessage("ERR_PPR_INSERTBEFID")].join(""),"_parseInsertData");}}}L.opId=G.trim(L.opId);return L;},processDelete:function(G,C,F){var B=this._Lang,E=this._Dom,H=F.getAttribute("id");if(!H){throw this._raiseError(new Error(),B.getMessage("ERR_PPR_UNKNOWNCID",null,"_AjaxResponse.processDelete",""),"processDelete");}var D=E.byIdOrName(H);if(!D){throw this._raiseError(new Error(),B.getMessage("ERR_PPR_UNKNOWNCID",null,"_AjaxResponse.processDelete",H),"processDelete");}var A=this._Dom.getParent(D,"form");if(null!=A){C._mfInternal._updateForms.push(A);}E.deleteItem(D);return true;},processAttributes:function(F,A,C){var D=this._Lang,B=C.getAttribute("id");if(!B){throw this._raiseError(new Error(),"Error in attributes, id not in xml markup","processAttributes");}var K=C.childNodes;if(!K){return false;}for(var I=0;I<K.length;I++){var E=K[I],J=E.getAttribute("name"),H=E.getAttribute("value");if(!J){continue;}J=D.trim(J);if("undefined"==typeof H||null==H){H="";}switch(B){case this.P_VIEWROOT:throw this._raiseError(new Error(),D.getMessage("ERR_NO_VIEWROOTATTR",null,"_AjaxResponse.processAttributes"),"processAttributes");case this.P_VIEWHEAD:throw this._raiseError(new Error(),D.getMessage("ERR_NO_HEADATTR",null,"_AjaxResponse.processAttributes"),"processAttributes");case this.P_VIEWBODY:var G=document.getElementsByTagName("body")[0];this._Dom.setAttribute(G,J,H);break;default:this._Dom.setAttribute(document.getElementById(B),J,H);break;}}return true;},_raiseError:function(D,H,B,F,A){var E=this.attr("impl");var I=F||E.MALFORMEDXML;var G=A||E.MALFORMEDXML;var C=H||"";return this._Lang.makeException(D,I,G,this._nameSpace,B||((arguments.caller)?arguments.caller.toString():"_raiseError"),C);}});