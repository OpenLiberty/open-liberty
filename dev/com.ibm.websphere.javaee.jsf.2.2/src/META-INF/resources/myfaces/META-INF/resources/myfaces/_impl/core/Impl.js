/*******************************************************************************
 * Copyright (c) 2017 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     IBM Corporation - initial API and implementation
 *******************************************************************************/
_MF_SINGLTN(_PFX_CORE+"Impl",_MF_OBJECT,{_transport:myfaces._impl.core._Runtime.getGlobalConfig("transport",myfaces._impl.xhrCore._Transports),_evtListeners:new (myfaces._impl.core._Runtime.getGlobalConfig("eventListenerQueue",myfaces._impl._util._ListenerQueue))(),_errListeners:new (myfaces._impl.core._Runtime.getGlobalConfig("errorListenerQueue",myfaces._impl._util._ListenerQueue))(),IDENT_ALL:"@all",IDENT_NONE:"@none",IDENT_THIS:"@this",IDENT_FORM:"@form",P_PARTIAL_SOURCE:"javax.faces.source",P_VIEWSTATE:"javax.faces.ViewState",P_CLIENTWINDOW:"javax.faces.ClientWindow",P_AJAX:"javax.faces.partial.ajax",P_EXECUTE:"javax.faces.partial.execute",P_RENDER:"javax.faces.partial.render",P_EVT:"javax.faces.partial.event",P_WINDOW_ID:"javax.faces.ClientWindow",P_RESET_VALUES:"javax.faces.partial.resetValues",ERROR:"error",EVENT:"event",BEGIN:"begin",COMPLETE:"complete",SUCCESS:"success",HTTPERROR:"httpError",EMPTY_RESPONSE:"emptyResponse",MALFORMEDXML:"malformedXML",SERVER_ERROR:"serverError",CLIENT_ERROR:"clientError",TIMEOUT_EVENT:"timeout",_threshold:"ERROR",_BLOCKFILTER:{onerror:1,onevent:1,render:1,execute:1,myfaces:1,delay:1,resetValues:1},getViewState:function(C){if(C){C=this._Lang.byId(C);}if(!C||!C.nodeName||C.nodeName.toLowerCase()!="form"){throw new Error(this._Lang.getMessage("ERR_VIEWSTATE"));}var B=myfaces._impl.xhrCore._AjaxUtils;var A=this._Lang.createFormDataDecorator([]);B.encodeSubmittableFields(A,C,null);return A.makeFinal();},request:function(H,D,O){if(this._delayTimeout){clearTimeout(this._delayTimeout);delete this._delayTimeout;}var I=this._Lang,L=this._Dom;I.assertType(O.onerror,"function");I.assertType(O.onevent,"function");O=O||{};if("undefined"==typeof D){D=window.event||null;}if(!H){throw I.makeException(new Error(),"ArgNotSet",null,this._nameSpace,"request",I.getMessage("ERR_MUST_BE_PROVIDED1","{0}: source  must be provided","jsf.ajax.request","source element id"));}var J=H;H=L.byIdOrName(H);if(!H){throw I.makeException(new Error(),"Notfound",null,this._nameSpace,"request",I.getMessage("ERR_PPR_UNKNOWNCID","{0}: Node with id {1} could not be found from source",this._nameSpace+".request",J));}var K=L.nodeIdOrName(H);var M=I.mixMaps({},O,true,this._BLOCKFILTER);if(D){M[this.P_EVT]=D.type;}var F={source:H,onevent:O.onevent,onerror:O.onerror,myfaces:O.myfaces,_mfInternal:{}};var A=F._mfInternal;var E=(O.myfaces&&O.myfaces.form)?I.byId(O.myfaces.form):this._getForm(H,D);var G=jsf.getClientWindow(E);if("undefined"!=typeof G&&null!=G){var C=L.getNamedElementFromForm(E,this.P_CLIENTWINDOW);if(C){F._mfInternal._clientWindow=jsf.getClientWindow(E);}else{M[this.P_CLIENTWINDOW]=jsf.getClientWindow(E);}}M[this.P_PARTIAL_SOURCE]=K;M[this.P_AJAX]=true;if(O.resetValues===true){M[this.P_RESET_VALUES]=true;}if(O.execute){O.execute=(O.execute.indexOf("@this")==-1)?O.execute:O.execute;this._transformList(M,this.P_EXECUTE,O.execute,E,K);}else{M[this.P_EXECUTE]=K;}if(O.render){this._transformList(M,this.P_RENDER,O.render,E,K);}var N=this._getTransportType(F,M,E);A["_mfSourceFormId"]=E.id;A["_mfSourceControlId"]=K;A["_mfTransportType"]=N;M[E.id]=E.id;var B=O.delay||this._RT.getLocalOrGlobalConfig(F,"delay",false);if(B){if(this._delayTimeout){clearTimeout(this._delayTimeout);}this._delayTimeout=setTimeout(I.hitch(this,function(){this._transport[N](H,E,F,M);this._delayTimeout=null;}),parseInt(B));}else{this._transport[N](H,E,F,M);}},_getForm:function(E,D){var C=this._Dom;var A=this._Lang;var B=C.fuzzyFormDetection(E);if(!B&&D){B=C.fuzzyFormDetection(A.getEventTarget(D));if(!B){throw A.makeException(new Error(),null,null,this._nameSpace,"_getForm",A.getMessage("ERR_FORM"));}}else{if(!B){throw A.makeException(new Error(),null,null,this._nameSpace,"_getForm",A.getMessage("ERR_FORM"));}}return B;},_getTransportType:function(B,I,A){var J=this._RT.getLocalOrGlobalConfig,E=this._Lang,H=this._Dom;var D=J(B,"transportAutoSelection",true);if(!D){return J(B,"transportType","xhrQueuedPost");}var F=H.isMultipartCandidate((!J(B,"pps",false))?A:I[this.P_EXECUTE]);var G=(H.getAttribute(A,"enctype")||"").toLowerCase()=="multipart/form-data";if(F&&!G){throw E.makeException(new Error(),null,null,this._nameSpace,"_getTransportType",E.getMessage("ERR_NO_MULTIPART_FORM","No Multipart form",A.id));}var C=F&&G;var K=(!C)?J(B,"transportType","xhrQueuedPost"):J(B,"transportType","multipartQueuedPost");if(!this._transport[K]){throw new Error(E.getMessage("ERR_TRANSPORT",null,K));}return K;},_transformList:function(J,H,C,A,F){var D=this._Lang;C=this._Lang.trim(C);var E=1,K=(C)?C.split(/\s+/):[],I=(K.length)?D.arrToMap(K,E):{},L=I[this.IDENT_NONE],M=I[this.IDENT_ALL],B=I[this.IDENT_THIS],G=I[this.IDENT_FORM];if(L){if("undefined"!=typeof J.target){delete J.target;}return J;}if(M){J[H]=this.IDENT_ALL;return J;}if(G){K[G-E]=A.id;}if(B&&!I[F]){K[B-E]=F;}J[H]=K.join(" ");return J;},addOnError:function(A){this._errListeners.enqueue(A);},addOnEvent:function(A){this._evtListeners.enqueue(A);},sendError:function sendError(H,D,B,P,N,E,C){var G=myfaces._impl._util._Lang;var L=G.getMessage("UNKNOWN");var O={};var I=function(){return(B&&B===myfaces._impl.core.Impl.MALFORMEDXML)?G.getMessage("ERR_MALFORMEDXML"):"";};O.type=this.ERROR;O.status=B||L;O.serverErrorName=P||L;O.serverErrorMessage=N||L;try{O.source=D.source||L;O.responseCode=H.status||L;O.responseText=H.responseText||L;O.responseXML=H.responseXML||L;}catch(J){}if(jsf.getProjectStage()==="Development"){O.serverErrorMessage=O.serverErrorMessage||"";O.serverErrorMessage=(E)?O.serverErrorMessage+"\nCalling class: "+E:O.serverErrorMessage;O.serverErrorMessage=(C)?O.serverErrorMessage+"\n Calling function: "+C:O.serverErrorMessage;}if(D["onerror"]){D.onerror(O);}this._errListeners.broadcastEvent(O);if(jsf.getProjectStage()==="Development"&&this._errListeners.length()==0&&!D["onerror"]){var A="--------------------------------------------------------",M=myfaces._impl.core._Runtime.getGlobalConfig("defaultErrorOutput",alert),F=[],K=G.hitch(F,F.push);(N)?K(G.getMessage("MSG_ERROR_MESSAGE")+" "+N+"\n"):null;K(A);(E)?K("Calling class:"+E):null;(C)?K("Calling function:"+C):null;(B)?K(G.getMessage("MSG_ERROR_NAME")+" "+B):null;(P&&B!=P)?K("Server error name: "+P):null;K(I());K(A);K(G.getMessage("MSG_DEV_MODE"));M(F.join("\n"));}},sendEvent:function sendEvent(D,B,A){var C=myfaces._impl._util._Lang;var I={};var H=C.getMessage("UNKNOWN");I.type=this.EVENT;I.status=A;I.source=B.source;if(A!==this.BEGIN){try{var E=function(K,J){try{return K[J];}catch(L){return H;}};I.responseCode=E(D,"status");I.responseText=E(D,"responseText");I.responseXML=E(D,"responseXML");}catch(F){var G=myfaces._impl.core._Runtime.getGlobalConfig("jsfAjaxImpl",myfaces._impl.core.Impl);G.sendError(D,B,this.CLIENT_ERROR,"ErrorRetrievingResponse",C.getMessage("ERR_CONSTRUCT",F.toString()));throw F;}}if(B.onevent){B.onevent.call(null,I);}this._evtListeners.broadcastEvent(I);},response:function(B,A){this._RT.getLocalOrGlobalConfig(A,"responseHandler",myfaces._impl.xhrCore._AjaxResponse).processResponse(B,A);},getSeparatorChar:function(){if(this._separator){return this.separatorchar;}var C="separatorchar",E=false,B=myfaces._impl.core._Runtime.getGlobalConfig,F=document.getElementsByTagName("script");for(var D=0;D<F.length&&!E;D++){if(F[D].src.search(/\/javax\.faces\.resource.*\/jsf\.js.*separator/)!=-1){E=true;var A=F[D].src.match(/separator=([^&;]*)/);this._separator=decodeURIComponent(A[1]);}}this._separator=B(C,this._separator||":");return this._separator;},getProjectStage:function(){if(!this._projectStage){var D="projectStage",E="Production",A=document.getElementsByTagName("script"),F=myfaces._impl.core._Runtime.getGlobalConfig,B=null,H=false,I={STG_PROD:1,"Development":1,"SystemTest":1,"UnitTest":1};for(var C=0;C<A.length&&!H;C++){if(A[C].src.search(/\/javax\.faces\.resource\/jsf\.js.*ln=javax\.faces/)!=-1){var G=A[C].src.match(/stage=([^&;]*)/);H=true;if(G){B=(I[G[1]])?G[1]:null;}else{B=F(D,E);}}}this._projectStage=F(D,B||E);}return this._projectStage;},chain:function(A,B){var I=arguments.length;var G=this._Lang;var E=function(K){throw Error("jsf.util.chain: "+G.getMessage(K));};var H=function(K,L){if(K===true){E(L);}};var C="function";var F=G.isString;H(I<2,"ERR_EV_OR_UNKNOWN");H(I<3&&(C==typeof B||F(B)),"ERR_EVT_PASS");if(I<3){return true;}H("undefined"==typeof A,"ERR_SOURCE_DEF_NULL");H(C==typeof A,"ERR_SOURCE_FUNC");H(F(A),"ERR_SOURCE_NOSTR");H(C==typeof B||F(B),"ERR_EV_OR_UNKNOWN");for(var D=2;D<I;D++){var J;if(C==typeof arguments[D]){J=arguments[D].call(A,B);}else{J=new Function("event",arguments[D]).call(A,B);}if(J===false){return false;}}return true;},stdErrorHandler:function(D,B,A){if(this._threshold=="ERROR"){var E=A._mfInternal||{};var C=[];C.push(A.message);this.sendError(D,B,E.title||this.CLIENT_ERROR,E.name||A.name,C.join("\n"),E.caller,E.callFunc);}},getClientWindow:function(C){var F=this._Lang.hitch(this,function(J){var H={};var G;var M=0;for(var L=J.length-1;L>=0;L--){var K=J[L];var N=this._Dom.getNamedElementFromForm(K,this.P_WINDOW_ID);var I=(N)?N.value:null;if(I){if(M>0&&"undefined"==typeof H[I]){throw Error("Multiple different windowIds found in document");}G=I;H[I]=true;M++;}}return G;});var E=function(){var H=window.location.href,G="jfwid";var J=new RegExp("[\\?&]"+G+"=([^&#\\;]*)");var I=J.exec(H);if(I!=null){return I[1];}return null;};var D=(C)?this._Dom.byId(C):document.body;var B=this._Dom.findByTagName(D,"form");var A=F(B);return(null!=A)?A:E();}});