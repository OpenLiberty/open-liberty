/*******************************************************************************
 * Copyright (c) 2018 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     IBM Corporation - initial API and implementation
 *******************************************************************************/

task copyEsas(type: Copy) {
    dependsOn parent.subprojects.assemble
    from cnf.fileTree(".").include("/release/dev/*/*/*.esa").files
    into 'build/esas'
}

task createSingleJson {
    // Run after all feature ESAs have been built
    dependsOn copyEsas
    doLast {
        ant.taskdef(name:'singleJsonRepo', classname:'generator.SingleJsonRepositoryGenerator') {
            classpath {
                fileset(dir: 'build/libs') {
                    include(name: 'com.ibm.ws.repository.generator.jar')
                }
                fileset(dir: "${rootDir}/com.ibm.ws.repository/build/libs") {
                    include(name: 'com.ibm.ws.repository.jar')
                }
                fileset(dir: "${rootDir}/com.ibm.ws.repository.parsers/build/libs") {
                    include(name: 'com.ibm.ws.repository.parsers.jar')
                }
                fileset(dir: "${rootDir}/com.ibm.ws.logging.core/build/libs") {
                    include(name: 'com.ibm.ws.logging.core.jar')
                }
                fileset(dir: "${rootDir}/com.ibm.ws.kernel.feature.core/build/libs") {
                    include(name: 'com.ibm.ws.kernel.feature.core.jar')
                }
             //   fileset(dir: "${rootDir}/*/build/libs/*") {
             //       include(name: '*.jar')
            //    }
            }
        }
        ant.touch(file:"SingleJson.json")

        def files = fileTree("build/esas").filter { it.isFile() }.files.name
        files.each {
            ant.singleJsonRepo(assetFile: file('build/esas/${it}'),
                    assetType:'FEATURE',
                    jsonFile:'SingleJson.json')
        }
    }
}